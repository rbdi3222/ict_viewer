<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ICT NetWorkì„¤ë¹„</title>
  <!-- Bootstrap (ì„ íƒ) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- TensorFlow.js + Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <style>
    body {
      margin: 0; 
      padding: 0; 
      font-family: sans-serif;
      background-color: #f7f9fc; 
      font-size: 18px;
    }
    header {
      background-color: #0d6efd; 
      color: #fff;
      text-align: center; 
      padding: 1.5rem;
    }
    header h1 { margin: 0; font-size: 2rem; }
    .container { max-width: 900px; margin: 0 auto; padding: 1rem; }
    #video {
      width: 100%; 
      max-width: 100%; 
      height: auto;
      background: #333; 
      border-radius: 0.5rem;
      margin: 1rem auto; 
      display: block; 
      object-fit: cover;
    }
    .device-info {
      background-color: #fff; 
      border-radius: 0.5rem;
      padding: 1.5rem; 
      margin-top: 2rem; 
      font-size: 1rem;
      text-align: center;
    }
    .device-info h4 { font-size: 1.3rem; }
    footer {
      text-align: center; 
      margin: 2rem 0 1rem 0;
      color: #666; 
      font-size: 1rem;
    }
    #btnStart {
      font-size: 1.2rem; 
      padding: 0.8rem 1.5rem;
      width: 100%; 
      max-width: 300px;
    }
    @media (max-width: 768px) {
      header h1 { font-size: 1.8rem; }
      .device-info { padding: 1rem; font-size: 0.9rem; }
      .device-info h4 { font-size: 1.2rem; }
      .container { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ë„¤íŠ¸ì›Œí¬ì„¤ë¹„ í™•ì¸</h1>
  </header>

  <div class="container text-center">
    <!-- âœ… ë³€ê²½ëœ ì¹´ë©”ë¼ ì„ íƒ UI -->
    <div class="d-flex justify-content-center align-items-center my-3" style="gap: 10px;">
      <label for="cameraSelect" style="font-size: 1.2rem; margin-bottom: 0;">ì¹´ë©”ë¼ ì„ íƒ :</label>
      <select id="cameraSelect" class="form-select" style="width: 200px; font-size: 1.1rem;">
      </select>
    </div>

    <!-- ì¹´ë©”ë¼ ì˜ìƒ í‘œì‹œ -->
    <video id="video" autoplay playsinline></video>

    <!-- ì„¤ë¹„ ì •ë³´ -->
    <div class="device-info">
      <h4>ì„¤ë¹„ëª… : <span id="deviceName">?</span></h4>
      <p id="deviceDesc">ì„¤ë¹„ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
      <!-- ë§¤ë‰´ì–¼ íŒŒì¼ ì´ë¦„ í‘œì‹œ: ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë  ì˜ì—­ -->
      <p id="manualFileName">
        ë©”ë‰´ì–¼ íŒŒì¼: <span style="color:gray;">(ì•„ì§ ì¸ì‹ëœ ì¥ë¹„ ì—†ìŒ)</span>
      </p>
    </div>
    
    <!-- ì‹¤ì‹œê°„ ì˜ˆì¸¡ í™•ë¥  (ë§¨ ì•„ë˜) -->
    <div id="label-container" class="mt-3"></div>
  </div>

  <footer>
    &copy; 2025 AIê¸°ë°˜ ICTì„¤ë¹„ í™•ì¸ ì‹œìŠ¤í…œ
  </footer>

  <script>
    /****************************************************
     * [0] manual í´ë” ë‚´ íŒŒì¼ ì´ë¦„ë“¤ì„ ë¯¸ë¦¬ ì €ì¥ (ì˜ˆì‹œ)
     * ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ì„œë²„ì—ì„œ ëª©ë¡ì„ ë°›ì•„ì˜¤ê±°ë‚˜, ë¹Œë“œ ì‹œ ì •ì  íŒŒì¼ ëª©ë¡ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     ****************************************************/
     const availableManualFiles = [
      "ANLAB_MANAUL.pdf",
      "CISCO_MANUAL_C9000Series.pdf",
      "COREEDGE_MANUAL_C3000.hwp",
      "DASAN_MANUAL_D2000,2124,2024.pdf",
      "DASAN_MANUAL_V8605,V6424.ppt",
      "NAC_MANUAL.pdf",
      "PIOLINK_MANUAL_S9700.pdf",
      "PIOLINK_MANUAL_S9710.pdf",
      "UBIQUOSS_MANUAL_30,40,50.pdf",
      "UBIQUOSS_MANUAL_E6100.pdf"
    ];

    // ì œì¡°ì‚¬ì— í•´ë‹¹í•˜ëŠ” ë©”ë‰´ì–¼ íŒŒì¼ ëª©ë¡ ë°˜í™˜ í•¨ìˆ˜
    function getManualFilesForManufacturer(manufacturer) {
      // ì˜ˆ: manufacturer = "NAC" => manualPrefix = "NAC_MANUAL"
      const manualPrefix = manufacturer + "_MANUAL";
      return availableManualFiles.filter(fileName =>
        fileName.startsWith(manualPrefix)
      );
    }

    /****************************************************
     * [1] ì¸ì‹ëœ ì¥ë¹„ëª…ì— ë”°ë¥¸ ë§¤ë‰´ì–¼ ëª©ë¡ í‘œì‹œ
     ****************************************************/
    const deviceNameEl = document.getElementById("deviceName");
    const deviceDescEl = document.getElementById("deviceDesc");
    const manualFileNameEl = document.getElementById("manualFileName");

    function setDeviceInfo(recognizedName) {
      // recognizedNameì— '-samples.zip' ë“±ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ì œê±°
      const deviceKey = recognizedName.replace("-samples.zip", "").trim();
      deviceNameEl.innerText = deviceKey;

      // "ì œì¡°ì‚¬_ëª¨ë¸ëª…" í˜•ì‹ ì²´í¬
      const parts = deviceKey.split("_");
      if (parts.length < 2) {
        deviceDescEl.innerText = "ì¥ë¹„ ì •ë³´ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        manualFileNameEl.innerHTML = "ë©”ë‰´ì–¼ íŒŒì¼: ì—†ìŒ";
        return;
      }
      // ì œì¡°ì‚¬ ì¶”ì¶œ (ì˜ˆ: "UBIQUOSS")
      const manufacturer = parts[0];

      // ì•ˆë‚´ ë¬¸êµ¬ ì—…ë°ì´íŠ¸
      deviceDescEl.innerText =
        "ì¸ì‹ëœ ì¥ë¹„ì— ëŒ€í•œ ë§¤ë‰´ì–¼ì„ ì•„ë˜ ë§í¬ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      manualFileNameEl.innerHTML = "ë©”ë‰´ì–¼ íŒŒì¼: ";

      // global arrayì—ì„œ í•´ë‹¹ ì œì¡°ì‚¬ì˜ ë©”ë‰´ì–¼ íŒŒì¼ë“¤ í•„í„°ë§
      const manualFiles = getManualFilesForManufacturer(manufacturer);
      if (manualFiles.length === 0) {
        const spanNoManual = document.createElement("span");
        spanNoManual.style.color = "red";
        spanNoManual.innerText = " (í•´ë‹¹ ì¥ë¹„ ë§¤ë‰´ì–¼ ì—†ìŒ)";
        manualFileNameEl.appendChild(spanNoManual);
        return;
      }
      // ë©”ë‰´ì–¼ íŒŒì¼ ë§í¬ ìƒì„±
      manualFiles.forEach((fileName, idx) => {
        const link = document.createElement("a");
        link.href = "./manual/" + encodeURIComponent(fileName);
        link.download = fileName;
        link.innerText = fileName;
        link.style.marginRight = "10px";
        if (idx > 0) {
          manualFileNameEl.appendChild(document.createTextNode(" | "));
        }
        manualFileNameEl.appendChild(link);
      });
    }

    /****************************************************
     * [2] ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸
     ****************************************************/
    async function checkCameraPermission() {
      try {
        const permission = await navigator.permissions.query({ name: "camera" });
        console.log("ğŸ“· ì¹´ë©”ë¼ ê¶Œí•œ ìƒíƒœ:", permission.state);
        if (permission.state === "denied") {
          alert("ì¹´ë©”ë¼ ì‚¬ìš©ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ë¥¼ í—ˆìš©í•´ì£¼ì„¸ìš”.");
          return;
        }
        if (permission.state === "prompt" || permission.state === "denied") {
          await navigator.mediaDevices.getUserMedia({ video: true });
          console.log("ğŸ“· ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì„±ê³µ");
        }
      } catch (error) {
        console.error("ğŸš¨ ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸ ì¤‘ ì˜¤ë¥˜:", error);
      }
    }

    /****************************************************
     * [3] ì „/í›„ë©´ ì¹´ë©”ë¼ ëª©ë¡ ì‹ë³„ -> <select>ì— ì¶”ê°€
     ****************************************************/
    const cameraSelect = document.getElementById("cameraSelect");
    let frontDeviceId = "";
    let rearDeviceId = "";

    async function listCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === "videoinput");

      frontDeviceId = "";
      rearDeviceId = "";

      cameraSelect.innerHTML = "";

      videoDevices.forEach(d => {
        const label = d.label.toLowerCase();
        const option = document.createElement("option");
        option.value = d.deviceId;

        if (label.includes("back") || label.includes("rear")) {
          rearDeviceId = d.deviceId;
          option.text = "í›„ë©´ ì¹´ë©”ë¼";  // âœ… í…ìŠ¤íŠ¸ ê°•ì œ ì§€ì •
          option.selected = true;       // âœ… ê¸°ë³¸ ì„ íƒ
        } else if (label.includes("front")) {
          frontDeviceId = d.deviceId;
          option.text = "ì „ë©´ ì¹´ë©”ë¼";  // âœ… í…ìŠ¤íŠ¸ ê°•ì œ ì§€ì •
        } else {
          // ì „ë©´/í›„ë©´ í‚¤ì›Œë“œê°€ ì—†ëŠ” ê²½ìš°
          option.text = d.label || "ê¸°ë³¸ ì¹´ë©”ë¼";
        }

        cameraSelect.appendChild(option);
      });

      // ë‘˜ ë‹¤ ì—†ì„ ë•Œ fallback
      if (!frontDeviceId && !rearDeviceId && videoDevices.length > 0) {
        const fallback = document.createElement("option");
        fallback.value = videoDevices[0].deviceId;
        fallback.text = videoDevices[0].label || "ê¸°ë³¸ ì¹´ë©”ë¼";
        cameraSelect.appendChild(fallback);
      }
    }

    /****************************************************
     * [4] ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë° + Teachable Machine ì˜ˆì¸¡
     ****************************************************/
    const videoEl = document.getElementById("video");
    const labelContainer = document.getElementById("label-container");
    let stream = null;
    let model = null;
    let loaded = false;

    async function startCameraAndPrediction() {
      const deviceId = cameraSelect.value;
      if (!deviceId) {
        alert("ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: {
          deviceId: { exact: deviceId },
          width: 640,
          height: 640
        }
      });
      videoEl.srcObject = stream;

      if (!loaded) {
        const modelURL = "./my_model/model.json";
        const metadataURL = "./my_model/metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        console.log("ëª¨ë¸ ë¡œë“œ ì™„ë£Œ");
        loaded = true;
      }
      predictLoop();
    }

    async function predictLoop() {
      if (!model) return;
      const predictions = await model.predict(videoEl);
      labelContainer.innerHTML = "";
      predictions.forEach(pred => {
        const div = document.createElement("div");
        div.textContent = `${pred.className}: ${pred.probability.toFixed(2)}`;
        labelContainer.appendChild(div);
      });

      // í™•ë¥ ì´ 1.00ì¸ í´ë˜ìŠ¤ê°€ ê°ì§€ë˜ë©´
      let recognizedName = null;
      for (let i = 0; i < predictions.length; i++) {
        const prob = predictions[i].probability.toFixed(2);
        if (prob === "1.00") {
          recognizedName = predictions[i].className;
          break;
        }
      }
      if (recognizedName) {
        // ì˜ˆ: recognizedNameì´ "UBIQUOSS_E6100"ì¼ ê²½ìš°
        setDeviceInfo(recognizedName);
      } else {
        deviceNameEl.innerText = "ì¸ì‹ëœ ì¥ë¹„ ì—†ìŒ";
        deviceDescEl.innerText = "ì¥ë¹„ê°€ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        manualFileNameEl.innerHTML = "ë©”ë‰´ì–¼ íŒŒì¼: ì—†ìŒ";
      }
      requestAnimationFrame(predictLoop);
    }

    /****************************************************
     * [5] í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
     ****************************************************/
    window.addEventListener("DOMContentLoaded", async () => {
      await checkCameraPermission();
      await listCameras();
      if (cameraSelect.options.length > 0) {
        startCameraAndPrediction().catch(err => {
          console.error(err);
          alert("ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err);
        });
      }
    });

        // âœ… select ì„ íƒ ì‹œ ìë™ ì‹¤í–‰
    cameraSelect.addEventListener("change", () => {
      startCameraAndPrediction().catch(err => {
        console.error(err);
        alert("ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err);
      });
    });

  </script>
</body>
</html>
